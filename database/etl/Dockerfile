FROM usgswma/iow_test_db:postgis11-jre11

LABEL maintainer=gs-w_eto_eb_federal_employees@usgs.gov

ARG ARS_REPO_ZIP_URL=https://github.com/NWQMC/schema-ars-stewards/archive/master.zip
ARG BIODATA_REPO_ZIP_URL=https://github.com/NWQMC/schema-biodata/archive/master.zip
ARG NWIS_REPO_ZIP_URL=https://github.com/NWQMC/schema-nwis-ws-star/archive/master.zip
ARG EPA_REPO_ZIP_URL=https://github.com/NWQMC/schema-epa/archive/master.zip
ARG SECURE_CURL=

ARG DEFAULT_PASSWORD=changeMe
ARG DEFAULT_DATABASE_NAME=wqp_db
ARG DEFAULT_DATABASE_ADDRESS=127.0.0.1
ARG DEFAULT_DB_OWNER_USERNAME=wqp_core

ARG CONTEXTS=external,ci,schemaLoad
ENV CONTEXTS="${CONTEXTS}"
ARG POSTGRES_PASSWORD="${DEFAULT_PASSWORD}"
ENV POSTGRES_PASSWORD="${POSTGRES_PASSWORD}"
ARG POSTGRES_DB="${DEFAULT_DATABASE_NAME}"
ENV POSTGRES_DB="${POSTGRES_DB}"

ARG WQP_DATABASE_ADDRESS="${DEFAULT_DATABASE_ADDRESS}"
ENV WQP_DATABASE_ADDRESS="${WQP_DATABASE_ADDRESS}"
ARG WQP_DATABASE_NAME="${DEFAULT_DATABASE_NAME}"
ENV WQP_DATABASE_NAME="${WQP_DATABASE_NAME}"
ARG WQP_DB_OWNER_USERNAME="${DEFAULT_DB_OWNER_USERNAME}"
ENV WQP_DB_OWNER_USERNAME="${WQP_DB_OWNER_USERNAME}"
ARG WQP_DB_OWNER_PASSWORD="${DEFAULT_PASSWORD}"
ENV WQP_DB_OWNER_PASSWORD="${WQP_DB_OWNER_PASSWORD}"
ARG WQP_SCHEMA_NAME=wqp
ENV WQP_SCHEMA_NAME="${WQP_SCHEMA_NAME}"
ARG WQP_SCHEMA_OWNER_USERNAME=wqp_core
ENV WQP_SCHEMA_OWNER_USERNAME="${WQP_SCHEMA_OWNER_USERNAME}"
ARG WQP_SCHEMA_OWNER_PASSWORD="${DEFAULT_PASSWORD}"
ENV WQP_SCHEMA_OWNER_PASSWORD="${WQP_SCHEMA_OWNER_PASSWORD}"
ARG WQP_READ_ONLY_USERNAME=wqp_user
ENV WQP_READ_ONLY_USERNAME="${WQP_READ_ONLY_USERNAME}"
ARG WQP_READ_ONLY_PASSWORD="${DEFAULT_PASSWORD}"
ENV WQP_READ_ONLY_PASSWORD="${WQP_READ_ONLY_PASSWORD}"

ARG ARS_DATABASE_ADDRESS="${DEFAULT_DATABASE_ADDRESS}"
ENV ARS_DATABASE_ADDRESS="${ARS_DATABASE_ADDRESS}"
ARG ARS_DATABASE_NAME="${DEFAULT_DATABASE_NAME}"
ENV ARS_DATABASE_NAME="${ARS_DATABASE_NAME}"
ARG ARS_DB_OWNER_USERNAME="${DEFAULT_DB_OWNER_USERNAME}"
ENV ARS_DB_OWNER_USERNAME="${ARS_DB_OWNER_USERNAME}"
ARG ARS_DB_OWNER_PASSWORD="${DEFAULT_PASSWORD}"
ENV ARS_DB_OWNER_PASSWORD="${ARS_DB_OWNER_PASSWORD}"
ARG ARS_SCHEMA_NAME=ars
ENV ARS_SCHEMA_NAME="${ARS_SCHEMA_NAME}"
ARG ARS_SCHEMA_OWNER_USERNAME=ars_owner
ENV ARS_SCHEMA_OWNER_USERNAME="${ARS_SCHEMA_OWNER_USERNAME}"
ARG ARS_SCHEMA_OWNER_PASSWORD="${DEFAULT_PASSWORD}"
ENV ARS_SCHEMA_OWNER_PASSWORD="${ARS_SCHEMA_OWNER_PASSWORD}"

ARG BIODATA_DATABASE_ADDRESS="${DEFAULT_DATABASE_ADDRESS}"
ENV BIODATA_DATABASE_ADDRESS="${BIODATA_DATABASE_ADDRESS}"
ARG BIODATA_DATABASE_NAME="${DEFAULT_DATABASE_NAME}"
ENV BIODATA_DATABASE_NAME="${BIODATA_DATABASE_NAME}"
ARG BIODATA_DB_OWNER_USERNAME="${DEFAULT_DB_OWNER_USERNAME}"
ENV BIODATA_DB_OWNER_USERNAME="${BIODATA_DB_OWNER_USERNAME}"
ARG BIODATA_DB_OWNER_PASSWORD="${DEFAULT_PASSWORD}"
ENV BIODATA_DB_OWNER_PASSWORD="${BIODATA_DB_OWNER_PASSWORD}"
ARG BIODATA_SCHEMA_NAME=biodata
ENV BIODATA_SCHEMA_NAME="${BIODATA_SCHEMA_NAME}"
ARG BIODATA_SCHEMA_OWNER_USERNAME=biodata_owner
ENV BIODATA_SCHEMA_OWNER_USERNAME="${BIODATA_SCHEMA_OWNER_USERNAME}"
ARG BIODATA_SCHEMA_OWNER_PASSWORD="${DEFAULT_PASSWORD}"
ENV BIODATA_SCHEMA_OWNER_PASSWORD="${BIODATA_SCHEMA_OWNER_PASSWORD}"

ARG NWIS_DATABASE_ADDRESS="${DEFAULT_DATABASE_ADDRESS}"
ENV NWIS_DATABASE_ADDRESS="${NWIS_DATABASE_ADDRESS}"
ARG NWIS_DATABASE_NAME="${DEFAULT_DATABASE_NAME}"
ENV NWIS_DATABASE_NAME="${NWIS_DATABASE_NAME}"
ARG NWIS_DB_OWNER_USERNAME="${DEFAULT_DB_OWNER_USERNAME}"
ENV NWIS_DB_OWNER_USERNAME="${NWIS_DB_OWNER_USERNAME}"
ARG NWIS_DB_OWNER_PASSWORD="${DEFAULT_PASSWORD}"
ENV NWIS_DB_OWNER_PASSWORD="${NWIS_DB_OWNER_PASSWORD}"
ARG NWIS_SCHEMA_NAME=nwis
ENV NWIS_SCHEMA_NAME="${NWIS_SCHEMA_NAME}"
ARG NWIS_SCHEMA_OWNER_USERNAME=nwis_ws_star
ENV NWIS_SCHEMA_OWNER_USERNAME="${NWIS_SCHEMA_OWNER_USERNAME}"
ARG NWIS_SCHEMA_OWNER_PASSWORD="${DEFAULT_PASSWORD}"
ENV NWIS_SCHEMA_OWNER_PASSWORD="${NWIS_SCHEMA_OWNER_PASSWORD}"

ARG EPA_DATABASE_ADDRESS="${DEFAULT_DATABASE_ADDRESS}"
ENV EPA_DATABASE_ADDRESS="${EPA_DATABASE_ADDRESS}"
ARG EPA_DATABASE_NAME="${DEFAULT_DATABASE_NAME}"
ENV EPA_DATABASE_NAME="${EPA_DATABASE_NAME}"
ARG EPA_DB_OWNER_USERNAME="${DEFAULT_DB_OWNER_USERNAME}"
ENV EPA_DB_OWNER_USERNAME="${EPA_DB_OWNER_USERNAME}"
ARG EPA_DB_OWNER_PASSWORD="${DEFAULT_PASSWORD}"
ENV EPA_DB_OWNER_PASSWORD="${EPA_DB_OWNER_PASSWORD}"
ARG EPA_SCHEMA_OWNER_USERNAME=epa_owner
ENV EPA_SCHEMA_OWNER_USERNAME="${EPA_SCHEMA_OWNER_USERNAME}"
ARG EPA_SCHEMA_OWNER_PASSWORD="${DEFAULT_PASSWORD}"
ENV EPA_SCHEMA_OWNER_PASSWORD="${EPA_SCHEMA_OWNER_PASSWORD}"
ARG WQX_SCHEMA_NAME=wqx
ENV WQX_SCHEMA_NAME="${WQX_SCHEMA_NAME}"
ARG WQX_DUMP_SCHEMA_NAME=wqx_dump
ENV WQX_DUMP_SCHEMA_NAME="${WQX_DUMP_SCHEMA_NAME}"
ARG STORETW_SCHEMA_NAME=storetw
ENV STORETW_SCHEMA_NAME="${STORETW_SCHEMA_NAME}"
ARG STORETW_DUMP_SCHEMA_NAME=storetw_dump
ENV STORETW_DUMP_SCHEMA_NAME="${STORETW_DUMP_SCHEMA_NAME}"

ARG WDFN_DB_READ_ONLY_USERNAME=wdfn_user
ENV WDFN_DB_READ_ONLY_USERNAME="${WDFN_DB_READ_ONLY_USERNAME}"
ARG WDFN_DB_READ_ONLY_PASSWORD="${DEFAULT_PASSWORD}"
ENV WDFN_DB_READ_ONLY_PASSWORD="${WDFN_DB_READ_ONLY_PASSWORD}"

############################################
# Grab files for initializing wqp database
############################################

ENV LIQUIBASE_WORKSPACE_WQP $LIQUIBASE_HOME/workspace/wqp
WORKDIR $LIQUIBASE_WORKSPACE_WQP
COPY ./liquibase/changeLogs $LIQUIBASE_WORKSPACE_WQP
COPY ./liquibase/scripts/*.sh /docker-entrypoint-initdb.d/
COPY ./liquibase/scripts/dbInit /docker-entrypoint-initdb.d/

ENV LIQUIBASE_WORKSPACE_ARS $LIQUIBASE_WORKSPACE/ars
WORKDIR $LIQUIBASE_WORKSPACE_ARS
RUN curl $SECURE_CURL $ARS_REPO_ZIP_URL -Lo master.zip
RUN unzip master.zip \
    && cp schema-ars-stewards-master/liquibase/scripts/z1_postgres_liquibase.sh /docker-entrypoint-initdb.d/z4_1_postgres_liquibase.sh \
    && cp schema-ars-stewards-master/liquibase/scripts/z2_ars_liquibase.sh /docker-entrypoint-initdb.d/z4_2_ars_liquibase.sh \
    && mv schema-ars-stewards-master/liquibase/changeLogs/* . \
    && rm master.zip

ENV LIQUIBASE_WORKSPACE_BIODATA $LIQUIBASE_WORKSPACE/biodata
WORKDIR $LIQUIBASE_WORKSPACE_BIODATA
RUN curl $SECURE_CURL $BIODATA_REPO_ZIP_URL -Lo master.zip
RUN unzip master.zip \
    && cp schema-biodata-master/liquibase/scripts/z1_postgres_liquibase.sh /docker-entrypoint-initdb.d/z5_1_postgres_liquibase.sh \
    && cp schema-biodata-master/liquibase/scripts/z2_biodata_liquibase.sh /docker-entrypoint-initdb.d/z5_2_biodata_liquibase.sh \
    && mv schema-biodata-master/liquibase/changeLogs/* . \
    && rm master.zip

ENV LIQUIBASE_WORKSPACE_NWIS $LIQUIBASE_WORKSPACE/nwis
WORKDIR $LIQUIBASE_WORKSPACE_NWIS
RUN curl $SECURE_CURL $NWIS_REPO_ZIP_URL -Lo master.zip
RUN unzip master.zip \
    && cp schema-nwis-ws-star-master/liquibase/scripts/z1_postgres_liquibase.sh /docker-entrypoint-initdb.d/z6_1_postgres_liquibase.sh \
    && cp schema-nwis-ws-star-master/liquibase/scripts/z2_nwis_liquibase.sh /docker-entrypoint-initdb.d/z6_2_nwis_liquibase.sh \
    && mv schema-nwis-ws-star-master/liquibase/changeLogs/* . \
    && rm master.zip

ENV LIQUIBASE_WORKSPACE_EPA $LIQUIBASE_WORKSPACE/epa
WORKDIR $LIQUIBASE_WORKSPACE_EPA
RUN curl $SECURE_CURL $EPA_REPO_ZIP_URL -Lo master.zip
RUN unzip master.zip \
    && cp schema-epa-master/liquibase/scripts/z1_postgres_liquibase.sh /docker-entrypoint-initdb.d/z7_1_postgres_liquibase.sh \
    && cp schema-epa-master/liquibase/scripts/z2_epa_liquibase.sh /docker-entrypoint-initdb.d/z7_2_epa_liquibase.sh \
    && mv schema-epa-master/liquibase/changeLogs/* . \
    && rm master.zip
